# –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥—É Airflow –≤ Kubernetes

## –û–±–∑–æ—Ä –¥–æ–±–∞–≤–ª–µ–Ω–Ω–æ–≥–æ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

–í –ø—Ä–æ–µ–∫—Ç –±—ã–ª –¥–æ–±–∞–≤–ª–µ–Ω –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π —Å—Ç–µ–∫ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–∑–≤–æ–ª—è–µ—Ç –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å:

### üìä –û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏:
- **CPU**: –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞ —É–∑–ª–æ–≤ –∏ –ø–æ–¥–æ–≤ Airflow
- **Memory**: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–æ–π –ø–∞–º—è—Ç–∏ —É–∑–ª–æ–≤ –∏ –ø–æ–¥–æ–≤ Airflow
- **Network**: –°–µ—Ç–µ–≤–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å (–≤—Ö–æ–¥—è—â–∏–π/–∏—Å—Ö–æ–¥—è—â–∏–π —Ç—Ä–∞—Ñ–∏–∫)
- **Disk I/O**: –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —á—Ç–µ–Ω–∏—è/–∑–∞–ø–∏—Å–∏ –Ω–∞ –¥–∏—Å–∫
- **Pod Status**: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–¥–æ–≤ –∏ –∏—Ö —Å—Ç–∞—Ç—É—Å

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### 1. –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ
```bash
cd k8s
./deploy.sh
```

### 2. –î–æ—Å—Ç—É–ø –∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞–º
```bash
# Airflow UI
kubectl port-forward svc/airflow-webserver 8080:8080 -n airflow

# Grafana
kubectl port-forward svc/grafana 3000:3000 -n airflow

# Prometheus (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
kubectl port-forward svc/prometheus 9090:9090 -n airflow
```

### 3. –û—Ç–∫—Ä—ã—Ç—å –≤ –±—Ä–∞—É–∑–µ—Ä–µ
- **Airflow**: http://localhost:8080 (admin/admin)
- **Grafana**: http://localhost:3000 (admin/admin)
- **Prometheus**: http://localhost:9090

## üìà –î–∞—à–±–æ—Ä–¥—ã Grafana

### 1. "Airflow Kubernetes Metrics" (–±–∞–∑–æ–≤—ã–π)
- –û–±—â–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ CPU –∏ –ø–∞–º—è—Ç–∏
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–¥–æ–≤
- –ë–∞–∑–æ–≤–∞—è —Å–µ—Ç–µ–≤–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å

### 2. "Airflow Advanced Kubernetes Metrics" (–¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π)
- –î–µ—Ç–∞–ª—å–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –ø–æ –∫–∞–∂–¥–æ–º—É –ø–æ–¥—É
- –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —É–∑–ª–æ–≤ –∏ –ø–æ–¥–æ–≤
- –î–∏—Å–∫–æ–≤–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
- –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è —Å–µ—Ç–µ–≤–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞

## üîß –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Node Exporter ‚îÇ‚îÄ‚îÄ‚îÄ‚ñ∫‚îÇ   Prometheus    ‚îÇ‚îÄ‚îÄ‚îÄ‚ñ∫‚îÇ     Grafana     ‚îÇ
‚îÇ  (–º–µ—Ç—Ä–∏–∫–∏ —É–∑–ª–æ–≤)‚îÇ    ‚îÇ (—Å–±–æ—Ä –º–µ—Ç—Ä–∏–∫)   ‚îÇ    ‚îÇ (–≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è)  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚ñ≤
                              ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê           ‚îÇ
‚îÇ Kubernetes API  ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
‚îÇ (–º–µ—Ç—Ä–∏–∫–∏ –ø–æ–¥–æ–≤) ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## üìã –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –ü–æ—Ä—Ç | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|-----------|------|------------|
| Prometheus | 9090 | –°–±–æ—Ä –∏ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫ |
| Grafana | 3000 | –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞—à–±–æ—Ä–¥–æ–≤ |
| Node Exporter | 9100 | –ú–µ—Ç—Ä–∏–∫–∏ —É–∑–ª–æ–≤ |

## üîç –ü–æ–ª–µ–∑–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã Prometheus

### CPU –º–µ—Ç—Ä–∏–∫–∏
```promql
# –ó–∞–≥—Ä—É–∑–∫–∞ CPU –ø–æ–¥–æ–≤ Airflow
rate(container_cpu_usage_seconds_total{namespace="airflow", pod=~"airflow-.*"}[5m]) * 100

# –ó–∞–≥—Ä—É–∑–∫–∞ CPU —É–∑–ª–æ–≤
100 - (avg by (instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100)
```

### Memory –º–µ—Ç—Ä–∏–∫–∏  
```promql
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏ –ø–æ–¥–æ–≤ Airflow
container_memory_usage_bytes{namespace="airflow", pod=~"airflow-.*"}

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏ —É–∑–ª–æ–≤
node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes
```

## üö® –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–ª–µ—Ä—Ç–æ–≤ (—Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ)

–î–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å Alertmanager:

```yaml
# –ü—Ä–∏–º–µ—Ä –ø—Ä–∞–≤–∏–ª–∞ –¥–ª—è –≤—ã—Å–æ–∫–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ CPU
groups:
- name: airflow.rules
  rules:
  - alert: AirflowHighCPUUsage
    expr: rate(container_cpu_usage_seconds_total{namespace="airflow"}[5m]) > 0.8
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "High CPU usage in Airflow pod"
```

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### –ö–ª—é—á–µ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è:

1. **CPU Usage** - –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å < 80% –≤ –Ω–æ—Ä–º–µ
2. **Memory Usage** - –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å —É—Ç–µ—á–∫–∏ –ø–∞–º—è—Ç–∏
3. **Pod Restarts** - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–æ–≤ –ø–æ–¥–æ–≤
4. **Network I/O** - –ø—Ä–æ–ø—É—Å–∫–Ω–∞—è —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å
5. **Disk I/O** - –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:

- –ï—Å–ª–∏ CPU > 80% –¥–ª–∏—Ç–µ–ª—å–Ω–æ–µ –≤—Ä–µ–º—è - —É–≤–µ–ª–∏—á–∏—Ç—å resources.limits
- –ï—Å–ª–∏ Memory —Ä–∞—Å—Ç–µ—Ç –ø–æ—Å—Ç–æ—è–Ω–Ω–æ - –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞ —É—Ç–µ—á–∫–∏ –ø–∞–º—è—Ç–∏
- –í—ã—Å–æ–∫–∏–π Disk I/O - –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å—ã –∫ –ë–î
- –ú–Ω–æ–≥–æ Network I/O - –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–∑–º–µ—Ä –ø–µ—Ä–µ–¥–∞–≤–∞–µ–º—ã—Ö –¥–∞–Ω–Ω—ã—Ö

## üõ† Troubleshooting

### Prometheus –Ω–µ —Å–æ–±–∏—Ä–∞–µ—Ç –º–µ—Ç—Ä–∏–∫–∏ –ø–æ–¥–æ–≤
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∞–Ω–Ω–æ—Ç–∞—Ü–∏–∏ –ø–æ–¥–æ–≤
kubectl get pods -n airflow -o yaml | grep -A 5 annotations

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å ServiceAccount –ø—Ä–∞–≤–∞
kubectl auth can-i get pods --as=system:serviceaccount:airflow:airflow -n airflow
```

### Grafana –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Prometheus
kubectl exec -it deployment/grafana -n airflow -- wget -qO- http://prometheus:9090/api/v1/label/__name__/values
```

### Node Exporter –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å DaemonSet
kubectl get daemonset node-exporter -n airflow
kubectl describe daemonset node-exporter -n airflow
```

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã

- [Prometheus Query Language](https://prometheus.io/docs/prometheus/latest/querying/)
- [Grafana Dashboard Best Practices](https://grafana.com/docs/grafana/latest/best-practices/)
- [Kubernetes Monitoring Guide](https://kubernetes.io/docs/tasks/debug-application-cluster/resource-monitoring/)
