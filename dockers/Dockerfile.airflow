# FROM registry.astralinux.ru/library/astra/ubi18:latest
FROM registry.astralinux.ru/library/astra/ubi18:1.8.2

ARG PYTHON_VERSION
ARG APACHE_AIRFLOW_VERSION
ARG AIRFLOW__CORE__LOAD_EXAMPLES
ARG AIRFLOW__CORE__EXECUTOR
ARG AIRFLOW__SCHEDULER__DAG_DIR_LIST_INTERVAL
ARG AIRFLOW__API__SECRET_KEY
ARG AIRFLOW__CELERY__BROKER_URL
ARG AIRFLOW__WEBSERVER__EXPOSE_CONFIG
ARG AIRFLOW__OPERATORS__DEFAULT_QUEUE
ARG AIRFLOW__CELERY__EXTRA_CELERY_CONFIG
ARG AIRFLOW__LOGGING__CELERY_LOGGING_LEVEL
ARG AIRFLOW__LOGGING__LOGGING_LEVEL
ARG AIRFLOW__CELERY__TASK_PUBLISH_MAX_RETRIES
ARG AIRFLOW__CELERY__BROKER_CONNECTION_TIMEOUT
ARG AIRFLOW__CELERY__OPERATION_TIMEOUT
ARG AIRFLOW__CELERY__BROKER_TRANSPORT_OPTIONS
# ARG AIRFLOW__CELERY__SSL_ACTIVE
# ARG AIRFLOW__CELERY__SSL_KEY
# ARG AIRFLOW__CELERY__SSL_CERT
# ARG AIRFLOW__CELERY__SSL_CACERT

ARG POSTGRES_DB_NAME
ARG POSTGRES_USER
ARG POSTGRES_USER_PASSWORD

RUN apt-get update
RUN apt-get install -y \
    iputils-ping  \
    curl \
    nano \
    python3-apt \
    python3-venv \
    python3-pip

RUN rm -rf /var/lib/apt/lists/*
RUN python3 -m venv /home/airflow/venv
ENV PATH="/home/airflow/venv/bin:$PATH"

RUN pip3 install --upgrade pip

ENV AIRFLOW_HOME=/opt/airflow
ENV AIRFLOW__DATABASE__SQL_ALCHEMY_CONN=postgresql+psycopg2://$POSTGRES_USER:$POSTGRES_USER_PASSWORD@airflow_postgresql:5432/$POSTGRES_DB_NAME
ENV AIRFLOW__CELERY__RESULT_BACKEND=db+postgresql+psycopg2://$POSTGRES_USER:$POSTGRES_USER_PASSWORD@airflow_postgresql:5432/$POSTGRES_DB_NAME
ENV AIRFLOW__CORE__LOAD_EXAMPLES=$AIRFLOW__CORE__LOAD_EXAMPLES
ENV AIRFLOW__CORE__EXECUTOR=$AIRFLOW__CORE__EXECUTOR
ENV AIRFLOW__SCHEDULER__DAG_DIR_LIST_INTERVAL=$AIRFLOW__SCHEDULER__DAG_DIR_LIST_INTERVAL
ENV AIRFLOW__API__SECRET_KEY=$AIRFLOW__API__SECRET_KEY
ENV AIRFLOW__CELERY__BROKER_URL=$AIRFLOW__CELERY__BROKER_URL
ENV AIRFLOW__WEBSERVER__EXPOSE_CONFIG=$AIRFLOW__WEBSERVER__EXPOSE_CONFIG
ENV AIRFLOW__OPERATORS__DEFAULT_QUEUE=$AIRFLOW__OPERATORS__DEFAULT_QUEUE
ENV AIRFLOW__CELERY__EXTRA_CELERY_CONFIG=$AIRFLOW__CELERY__EXTRA_CELERY_CONFIG
ENV AIRFLOW__LOGGING__CELERY_LOGGING_LEVEL=$AIRFLOW__LOGGING__CELERY_LOGGING_LEVEL
ENV AIRFLOW__LOGGING__LOGGING_LEVEL=$AIRFLOW__LOGGING__LOGGING_LEVEL
ENV AIRFLOW__CELERY__TASK_PUBLISH_MAX_RETRIES=$AIRFLOW__CELERY__TASK_PUBLISH_MAX_RETRIES
ENV AIRFLOW__CELERY__BROKER_CONNECTION_TIMEOUT=$AIRFLOW__CELERY__BROKER_CONNECTION_TIMEOUT
ENV AIRFLOW__CELERY__OPERATION_TIMEOUT=$AIRFLOW__CELERY__OPERATION_TIMEOUT
ENV AIRFLOW__CELERY__TASK_TIMEOUT=300
ENV AIRFLOW__CELERY__TASK_SOFT_TIME_LIMIT=240
# ENV AIRFLOW__CELERY__SSL_ACTIVE=$AIRFLOW__CELERY__SSL_ACTIVE
# ENV AIRFLOW__CELERY__SSL_KEY=$AIRFLOW__CELERY__SSL_KEY
# ENV AIRFLOW__CELERY__SSL_CERT=$AIRFLOW__CELERY__SSL_CERT
# ENV AIRFLOW__CELERY__SSL_CACERT=$AIRFLOW__CELERY__SSL_CACERT
# ENV AIRFLOW__CELERY__BROKER_TRANSPORT_OPTIONS=$AIRFLOW__CELERY__BROKER_TRANSPORT_OPTIONS


RUN pip3 install "apache-airflow[postgres,celery,rabbitmq,flower,kubernetes]==$APACHE_AIRFLOW_VERSION" --constraint \
    "https://raw.githubusercontent.com/apache/airflow/constraints-$APACHE_AIRFLOW_VERSION/constraints-$PYTHON_VERSION.txt" 
RUN pip3 install psycopg2-binary

EXPOSE 8793